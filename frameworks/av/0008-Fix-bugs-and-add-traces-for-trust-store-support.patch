From 52ff5dcae35b50bf36fa4e8d340ca0ca81d0966e Mon Sep 17 00:00:00 2001
From: Alfonso Sanchez-Beato <alfonso.sanchez-beato@canonical.com>
Date: Thu, 13 Aug 2015 19:03:29 +0200
Subject: [PATCH 08/12] Fix bugs and add traces for trust-store support

Change-Id: Ia6312354e1a6111e3016829d2edb7e2804639b98
---
 .../camera/libcameraservice/CameraService.cpp | 65 ++++++++++++++++---
 1 file changed, 56 insertions(+), 9 deletions(-)

diff --git a/services/camera/libcameraservice/CameraService.cpp b/services/camera/libcameraservice/CameraService.cpp
index 993cd28..30cc5c8 100644
--- a/services/camera/libcameraservice/CameraService.cpp
+++ b/services/camera/libcameraservice/CameraService.cpp
@@ -21,7 +21,9 @@
 #include <algorithm>
 #include <climits>
 #include <stdio.h>
-#include <cstdlib>
+#include <fstream>
+#include <errno.h>
+#include <string.h>
 #include <cstring>
 #include <ctime>
 #include <iostream>
@@ -34,6 +36,7 @@
 
 #include <android/hardware/ICamera.h>
 #include <android/hardware/ICameraClient.h>
+#include <android/looper.h>
 
 #include <aidl/AidlCameraService.h>
 #include <android-base/macros.h>
@@ -130,6 +133,19 @@ struct TrustAgentRegistry : public android::Thread,
     {
         static const int socketErrorCode = -1;
 
+        {
+            // Keep this disabled for distros which don't carry the necessary kernel patch
+            enabled = false;
+
+            std::ifstream kernelSetting;
+            kernelSetting.open("/sys/module/binder/parameters/global_pid_lookups", std::ifstream::in);
+            if (kernelSetting.is_open()) {
+                std::string param;
+                kernelSetting >> param;
+                enabled = (param.find("Y") == 0);
+            }
+        }
+
         // We create a unix domain socket
         socketFd = ::socket(PF_UNIX, SOCK_STREAM, 0);
 
@@ -152,7 +168,7 @@ struct TrustAgentRegistry : public android::Thread,
 
         // And bind to the endpoint in the filesystem.
         static const int bindErrorCode = -1;
-        int rc = ::bind(socketFd, reinterpret_cast<sockaddr*>(&address), sizeof(sockaddr_un));        
+        int rc = ::bind(socketFd, reinterpret_cast<sockaddr*>(&address), sizeof(sockaddr_un));
 
         if (rc == bindErrorCode)
         {
@@ -205,6 +221,8 @@ struct TrustAgentRegistry : public android::Thread,
         static const int keepOn = 1;
         static const int bailOut = 0;
 
+        ALOGD("%s", __PRETTY_FUNCTION__);
+
         if (fd != socketFd)
             return keepOn;
 
@@ -239,6 +257,7 @@ struct TrustAgentRegistry : public android::Thread,
             ALOGE("Could not query peer credentials");
         } else
         {
+            ALOGD("%s adding uid %d fd %d", __PRETTY_FUNCTION__, peerCredentials.uid, connectionFd);
             android::AutoMutex am(remoteAgentsGuard);
             remoteAgents.add(peerCredentials.uid, connectionFd);
         }
@@ -249,9 +268,17 @@ struct TrustAgentRegistry : public android::Thread,
     // From android::Thread
     bool threadLoop()
     {
-        static const int timeoutInMs = 5000;
+        static const int timeoutInMs = -1;
+        int res;
+
+        ALOGD("%s start", __PRETTY_FUNCTION__);
+
+        do {
+            res = looper->pollOnce(timeoutInMs);
+            ALOGD("%s res %d", __PRETTY_FUNCTION__, res);
+        } while(res != ALOOPER_POLL_ERROR);
 
-        looper->pollOnce(timeoutInMs);
+        ALOGD("%s exit", __PRETTY_FUNCTION__);
 
         return exitPending();
     }
@@ -260,25 +287,40 @@ struct TrustAgentRegistry : public android::Thread,
     {
         int socket = -1;
 
+        // If the kernel features are not enabled just let the request through.
+        // For distros which don't ship the necessary kernel patch.
+        if (!enabled)
+            return true;
+
+        ALOGD("%s uid %d pid %d", __PRETTY_FUNCTION__, uid, pid);
+
         // Scoping access to the known remoteAgents here.
         {
             android::AutoMutex am(remoteAgentsGuard);
             ssize_t idx = remoteAgents.indexOfKey(uid);
-            if (idx == -1)
+            if (idx < 0) {
+                ALOGE("No trust store connection found for user %d", uid);
                 return false;
+            }
 
-            socket = remoteAgents.keyAt(idx);
+            socket = remoteAgents[idx];
         }
 
         Request request; request.uid = uid; request.pid = pid; request.feature = 0; request.startTime = -1;
 
-        if (::write(socket, &request, sizeof(Request)) == -1)
+        if (::write(socket, &request, sizeof(Request)) == -1) {
+            ALOGE("%s write error: %s (%d)", __PRETTY_FUNCTION__, strerror(errno), errno);
             return false;
+        }
 
         int32_t answerFromSocket = denied;
 
-        if (::read(socket, &answerFromSocket, sizeof(::int32_t)) == -1)
+        if (::read(socket, &answerFromSocket, sizeof(::int32_t)) == -1) {
+            ALOGE("%s read error: %s (%d)", __PRETTY_FUNCTION__, strerror(errno), errno);
             return false;
+        }
+
+        ALOGD("%s answerFromSocket %d", __PRETTY_FUNCTION__, answerFromSocket);
 
         return answerFromSocket == granted;
     }
@@ -287,6 +329,7 @@ struct TrustAgentRegistry : public android::Thread,
     android::sp<android::Looper> looper;
     android::Mutex remoteAgentsGuard;
     android::KeyedVector<uid_t, int> remoteAgents;
+    bool enabled;
 };
 
 android::sp<TrustAgentRegistry> trust_agent_registry(new TrustAgentRegistry("/dev/socket/camera_service/camera_service_to_trust"));
@@ -2008,7 +2051,11 @@ Status CameraService::validateClientPermissionsLocked(const std::string& cameraI
         // verify that the app with uid and pid is allowed to access the
         // camera.
         if (!trust_agent_registry->verifyConnectRequestFor(clientUid, callingPid))
-            return PERMISSION_DENIED;
+            return STATUS_ERROR_FMT(ERROR_PERMISSION_DENIED,
+                    "Untrusted caller (calling PID %d, UID %d) trying to "
+                    "forward camera access to camera %s for client %s (PID %d, UID %d)",
+                    callingPid, callingUid, cameraId.c_str(),
+                    clientName.c_str(), clientUid, clientPid);
     } else if (!isTrustedCallingUid(callingUid)) {
         ALOGE("CameraService::connect X (calling PID %d, calling UID %d) rejected "
                 "(don't trust clientUid %d)", callingPid, callingUid, clientUid);
-- 
2.45.2

